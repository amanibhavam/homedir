#!/usr/bin/env bash

function main {
  set -efu

  local nm_job="$(git remote get-url origin | perl -pe 's{^.*?github.com[:/]}{}; s{/+}{--}')"

  if [[ -z "${VAULT_TOKEN:-}" ]]; then
    vault login -method=oidc role="env-${nm_job}"
    export VAULT_TOKEN="$(pass vault-token)"
  fi

  exec envconsul -no-prefix -upcase -sanitize -once -log-level ERR -secret "kv/pipeline/${nm_job}" "$@"
}

source sub "$0" "$@"
