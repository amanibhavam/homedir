#!/usr/bin/env bash

function main {
  set -efu

  if [[ "$(id -un)" = "cloudshell-user" ]]; then
    sudo yum upgrade -y
    sudo yum install -y rsync
    sudo mkdir -p /asdf/installs
    sudo curl -sSL -o /usr/local/bin/powerline-go https://github.com/justjanne/powerline-go/releases/download/v1.18.0/powerline-go-linux-amd64
    sudo chmod 755 /usr/local/bin/powerline-go
  else
    if [[ ! -d /home/linuxbrew ]]; then
      if [[ "$(uname -s)" != "Darwin" ]]; then
        if [[ -x "$(type -P apt)" ]]; then
          sudo apt update
          sudo apt install -y make unzip python3-venv build-essential jq net-tools docker.io

          sudo install -d -o 1000 -g 1000 /home/linuxbrew
          git clone --depth 1 https://github.com/Homebrew/brew /home/linuxbrew/.linuxbrew
          git clone --depth 1 https://github.com/Homebrew/linuxbrew-core \
            /home/linuxbrew/.linuxbrew/Library/Taps/homebrew/homebrew-core

          /home/linuxbrew/.linuxbrew/bin/brew tap linuxbrew/xorg
        fi
      fi
    fi

    if [[ -f /efs/backup/linuxbrew-install.tar.gz ]]; then
      pushd /home
      sudo install -d -o 1000 -g 1000 linuxbrew
      cd linuxbrew
      tar xvfz /efs/backup/linuxbrew-install.tar.gz 
      popd
    fi

    if [[ ! -x "$(which brew || true)" ]]; then
      case "$(uname -s)" in
        Darwin)
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          brew install jq
          ;;
      esac
    fi
  fi

  PATH="$HOME/.asdf/installs/bin:$PATH"
  PATH="/home/linuxbrew/.linuxbrew/sbin:/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/opt/java/bin:$PATH"

  rsync -ia homedir/.git .
  git reset --hard
  rm -rf .asdf/installs
  ln -nfs /asdf/installs .asdf/installs
  make update
  make install
  rm -rf homedir
}

main "$@"
